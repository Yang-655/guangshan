<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è§†é¢‘å‘å¸ƒåŠŸèƒ½æµ‹è¯• - Blob URLä¿®å¤éªŒè¯</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .info {
            background-color: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        video {
            max-width: 100%;
            height: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¬ è§†é¢‘å‘å¸ƒåŠŸèƒ½æµ‹è¯• - Blob URLä¿®å¤éªŒè¯</h1>
        <p>æ­¤é¡µé¢ç”¨äºæµ‹è¯•ä¿®å¤åçš„è§†é¢‘å‘å¸ƒåŠŸèƒ½ï¼ŒéªŒè¯blob URLå¤±æ•ˆé—®é¢˜æ˜¯å¦å·²è§£å†³ã€‚</p>
        
        <div class="test-section info">
            <h3>ğŸ“‹ æµ‹è¯•æ­¥éª¤</h3>
            <ol>
                <li>ç‚¹å‡»"åˆ›å»ºæµ‹è¯•è§†é¢‘"æŒ‰é’®ç”Ÿæˆä¸€ä¸ªæµ‹è¯•è§†é¢‘blob</li>
                <li>ç‚¹å‡»"æ¨¡æ‹Ÿblob URLå¤±æ•ˆ"æŒ‰é’®æ¨¡æ‹ŸURLå¤±æ•ˆæƒ…å†µ</li>
                <li>ç‚¹å‡»"æµ‹è¯•è§†é¢‘å‘å¸ƒ"æŒ‰é’®éªŒè¯å‘å¸ƒåŠŸèƒ½</li>
                <li>è§‚å¯Ÿæ—¥å¿—è¾“å‡ºï¼Œç¡®è®¤æ˜¯å¦ä½¿ç”¨äº†å¤‡ç”¨çš„Blobå¯¹è±¡</li>
            </ol>
        </div>

        <div class="test-section">
            <h3>ğŸ¥ æµ‹è¯•è§†é¢‘ç”Ÿæˆ</h3>
            <button id="createVideoBtn">åˆ›å»ºæµ‹è¯•è§†é¢‘</button>
            <button id="invalidateBlobBtn" disabled>æ¨¡æ‹Ÿblob URLå¤±æ•ˆ</button>
            <button id="testPublishBtn" disabled>æµ‹è¯•è§†é¢‘å‘å¸ƒ</button>
            <div id="videoContainer"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ“Š æµ‹è¯•ç»“æœ</h3>
            <div id="testResults"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ“ è¯¦ç»†æ—¥å¿—</h3>
            <div id="testLog" class="log"></div>
        </div>
    </div>

    <script>
        let testVideoBlob = null;
        let testVideoUrl = null;
        let blobInvalidated = false;

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('testLog');
            const logEntry = document.createElement('div');
            logEntry.style.color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'black';
            logEntry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function updateResults(message, type) {
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.className = `test-section ${type}`;
            resultsDiv.innerHTML = `<h4>æµ‹è¯•ç»“æœ</h4><p>${message}</p>`;
        }

        // åˆ›å»ºæµ‹è¯•è§†é¢‘
        document.getElementById('createVideoBtn').addEventListener('click', async () => {
            try {
                log('å¼€å§‹åˆ›å»ºæµ‹è¯•è§†é¢‘...');
                
                // åˆ›å»ºä¸€ä¸ªç®€å•çš„è§†é¢‘blobï¼ˆå®é™…ä¸Šæ˜¯ä¸€ä¸ªå¾ˆå°çš„webmæ–‡ä»¶å¤´ï¼‰
                const canvas = document.createElement('canvas');
                canvas.width = 320;
                canvas.height = 240;
                const ctx = canvas.getContext('2d');
                
                // ç»˜åˆ¶ä¸€ä¸ªç®€å•çš„æµ‹è¯•å›¾æ¡ˆ
                ctx.fillStyle = '#4CAF50';
                ctx.fillRect(0, 0, 320, 240);
                ctx.fillStyle = 'white';
                ctx.font = '20px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('æµ‹è¯•è§†é¢‘', 160, 120);
                ctx.fillText(new Date().toLocaleTimeString(), 160, 150);
                
                // è½¬æ¢ä¸ºblob
                canvas.toBlob((blob) => {
                    testVideoBlob = blob;
                    testVideoUrl = URL.createObjectURL(blob);
                    
                    log(`æµ‹è¯•è§†é¢‘åˆ›å»ºæˆåŠŸï¼Œå¤§å°: ${blob.size} bytes`);
                    log(`Blob URL: ${testVideoUrl}`);
                    
                    // æ˜¾ç¤ºè§†é¢‘é¢„è§ˆï¼ˆè™½ç„¶æ˜¯å›¾ç‰‡æ ¼å¼ï¼Œä½†ç”¨äºæµ‹è¯•ï¼‰
                    const videoContainer = document.getElementById('videoContainer');
                    videoContainer.innerHTML = `
                        <p>æµ‹è¯•è§†é¢‘å·²åˆ›å»º:</p>
                        <img src="${testVideoUrl}" style="max-width: 200px; border: 1px solid #ddd;" alt="æµ‹è¯•è§†é¢‘">
                        <p>Blobå¤§å°: ${blob.size} bytes</p>
                        <p>Blobç±»å‹: ${blob.type}</p>
                    `;
                    
                    document.getElementById('invalidateBlobBtn').disabled = false;
                    document.getElementById('testPublishBtn').disabled = false;
                    
                    updateResults('æµ‹è¯•è§†é¢‘åˆ›å»ºæˆåŠŸï¼', 'success');
                }, 'image/png');
                
            } catch (error) {
                log(`åˆ›å»ºæµ‹è¯•è§†é¢‘å¤±è´¥: ${error.message}`, 'error');
                updateResults(`åˆ›å»ºæµ‹è¯•è§†é¢‘å¤±è´¥: ${error.message}`, 'error');
            }
        });

        // æ¨¡æ‹Ÿblob URLå¤±æ•ˆ
        document.getElementById('invalidateBlobBtn').addEventListener('click', () => {
            if (testVideoUrl) {
                log('æ¨¡æ‹Ÿblob URLå¤±æ•ˆ...');
                URL.revokeObjectURL(testVideoUrl);
                blobInvalidated = true;
                log('Blob URLå·²è¢«æ’¤é”€ï¼Œç°åœ¨åº”è¯¥æ— æ³•è®¿é—®');
                
                // æ›´æ–°æ˜¾ç¤º
                const videoContainer = document.getElementById('videoContainer');
                videoContainer.innerHTML += '<p style="color: red;">âš ï¸ Blob URLå·²å¤±æ•ˆ</p>';
                
                updateResults('Blob URLå·²å¤±æ•ˆï¼Œå‡†å¤‡æµ‹è¯•å¤‡ç”¨æ–¹æ¡ˆ', 'info');
            }
        });

        // æµ‹è¯•è§†é¢‘å‘å¸ƒ
        document.getElementById('testPublishBtn').addEventListener('click', async () => {
            try {
                log('å¼€å§‹æµ‹è¯•è§†é¢‘å‘å¸ƒåŠŸèƒ½...');
                
                // æ¨¡æ‹Ÿå‘å¸ƒæ•°æ®
                const publishData = {
                    title: 'æµ‹è¯•è§†é¢‘å‘å¸ƒ',
                    description: 'è¿™æ˜¯ä¸€ä¸ªç”¨äºæµ‹è¯•blob URLä¿®å¤çš„è§†é¢‘',
                    userId: 'user_demo_001',
                    duration: 10,
                    videoUrl: testVideoUrl, // å¯èƒ½å·²å¤±æ•ˆçš„URL
                    videoBlob: testVideoBlob, // å¤‡ç”¨çš„åŸå§‹Blobå¯¹è±¡
                    hashtags: ['æµ‹è¯•', 'blobä¿®å¤'],
                    privacyLevel: 'public'
                };
                
                log('å‡†å¤‡å‘å¸ƒæ•°æ®:');
                log(`- æ ‡é¢˜: ${publishData.title}`);
                log(`- è§†é¢‘URL: ${publishData.videoUrl}`);
                log(`- è§†é¢‘Blob: ${publishData.videoBlob ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}`);
                log(`- Blobå¤§å°: ${publishData.videoBlob ? publishData.videoBlob.size + ' bytes' : 'N/A'}`);
                log(`- URLæ˜¯å¦å¤±æ•ˆ: ${blobInvalidated ? 'æ˜¯' : 'å¦'}`);
                
                // æµ‹è¯•blob URLæœ‰æ•ˆæ€§
                if (blobInvalidated) {
                    log('æµ‹è¯•å¤±æ•ˆçš„blob URLè®¿é—®...');
                    try {
                        const response = await fetch(testVideoUrl);
                        log(`æ„å¤–ï¼šå¤±æ•ˆçš„URLä»å¯è®¿é—®ï¼ŒçŠ¶æ€: ${response.status}`);
                    } catch (error) {
                        log('ç¡®è®¤ï¼šå¤±æ•ˆçš„URLæ— æ³•è®¿é—® âœ“', 'success');
                    }
                }
                
                // æ¨¡æ‹Ÿå‘å¸ƒè¿‡ç¨‹
                log('æ¨¡æ‹Ÿè§†é¢‘å‘å¸ƒè¿‡ç¨‹...');
                
                // æ£€æŸ¥æ˜¯å¦éœ€è¦ä½¿ç”¨å¤‡ç”¨Blob
                if (blobInvalidated && publishData.videoBlob) {
                    log('æ£€æµ‹åˆ°URLå¤±æ•ˆï¼Œä½¿ç”¨å¤‡ç”¨Blobå¯¹è±¡ âœ“', 'success');
                    
                    // æ¨¡æ‹Ÿè½¬æ¢ä¸ºbase64
                    const reader = new FileReader();
                    reader.onload = function() {
                        const base64Data = reader.result;
                        log(`æˆåŠŸå°†å¤‡ç”¨Blobè½¬æ¢ä¸ºbase64ï¼Œå¤§å°: ${Math.round(base64Data.length / 1024)} KB`, 'success');
                        log('è§†é¢‘å‘å¸ƒæ¨¡æ‹Ÿå®Œæˆ âœ“', 'success');
                        updateResults('âœ… æµ‹è¯•æˆåŠŸï¼å¤‡ç”¨Blobæ–¹æ¡ˆå·¥ä½œæ­£å¸¸ï¼Œblob URLå¤±æ•ˆé—®é¢˜å·²ä¿®å¤', 'success');
                    };
                    reader.onerror = function() {
                        log('è½¬æ¢å¤‡ç”¨Blobå¤±è´¥', 'error');
                        updateResults('âŒ æµ‹è¯•å¤±è´¥ï¼šæ— æ³•è½¬æ¢å¤‡ç”¨Blob', 'error');
                    };
                    reader.readAsDataURL(publishData.videoBlob);
                } else if (!blobInvalidated) {
                    log('URLä»ç„¶æœ‰æ•ˆï¼Œæ­£å¸¸å¤„ç†', 'success');
                    updateResults('âœ… æµ‹è¯•æˆåŠŸï¼URLæœ‰æ•ˆï¼Œæ­£å¸¸å‘å¸ƒæµç¨‹', 'success');
                } else {
                    log('æ²¡æœ‰å¤‡ç”¨Blobå¯¹è±¡ï¼Œå‘å¸ƒå¯èƒ½å¤±è´¥', 'error');
                    updateResults('âŒ æµ‹è¯•å¤±è´¥ï¼šæ²¡æœ‰å¤‡ç”¨æ•°æ®æº', 'error');
                }
                
            } catch (error) {
                log(`æµ‹è¯•å‘å¸ƒå¤±è´¥: ${error.message}`, 'error');
                updateResults(`æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        });

        // é¡µé¢åŠ è½½å®Œæˆ
        log('æµ‹è¯•é¡µé¢å·²åŠ è½½ï¼Œå‡†å¤‡å¼€å§‹æµ‹è¯•');
        updateResults('è¯·ç‚¹å‡»"åˆ›å»ºæµ‹è¯•è§†é¢‘"å¼€å§‹æµ‹è¯•', 'info');
    </script>
</body>
</html>